<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.with-nav {
      padding-top: 60px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      min-height: 100vh;
    }

    .form-container {
      background: none;
      padding: 20px;
      border-radius: 0;
      box-shadow: none;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .page-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 60px 30px;
      background: linear-gradient(135deg, #17408B 0%, #C9082A 100%);
      border-radius: 20px;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .page-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(-50px) translateY(-50px); }
      100% { transform: translateX(50px) translateY(50px); }
    }

    .page-header h1 {
      font-size: 3em;
      margin-bottom: 15px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
      color: white !important;
    }

    .page-header p {
      font-size: 1.2em;
      opacity: 0.9;
      position: relative;
      z-index: 1;
      color: white !important;
      margin: 0;
    }

    /* Admin Content Container */
    .admin-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 40px 0;
    }

    h1, h2, h3 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
      font-weight: 700;
    }

    .admin-content h1 {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #333;
    }

    .admin-content h2 {
      font-size: 1.8em;
      color: #17408B;
      margin: 40px 0 25px 0;
    }

    .admin-content h3 {
      font-size: 1.4em;
      color: #C9082A;
      margin: 30px 0 20px 0;
    }

    /* Input Fields */
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s ease;
      background-color: #fff;
      color: #333;
      box-sizing: border-box;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: #17408B;
      box-shadow: 0 0 0 3px rgba(23, 64, 139, 0.1);
    }

    /* Buttons */
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #17408B 0%, #C9082A 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 16px;
      text-align: center;
      transition: background-color 0.3s ease;
      color: #333;
    }

    th {
      background: linear-gradient(135deg, #17408B 0%, #C9082A 100%);
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9em;
    }

    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    tbody tr:hover {
      background-color: #e3f2fd;
    }

    /* Support Tickets Styles */
    .tickets-container {
      margin-top: 20px;
    }

    .tickets-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .tickets-controls select {
      width: auto;
      min-width: 150px;
      margin-bottom: 0;
    }

    .ticket-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .ticket-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    .ticket-id {
      font-size: 1.1em;
      font-weight: 700;
      color: #17408B;
    }

    .ticket-user {
      font-size: 0.9em;
      color: #666;
      font-weight: 600;
    }

    .ticket-status {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ticket-status.open {
      background: #ffc107;
      color: #856404;
    }

    .ticket-status.in-progress {
      background: #17a2b8;
      color: white;
    }

    .ticket-status.resolved {
      background: #28a745;
      color: white;
    }

    .ticket-priority {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 10px;
    }

    .ticket-priority.high {
      background: #dc3545;
      color: white;
    }

    .ticket-priority.medium {
      background: #fd7e14;
      color: white;
    }

    .ticket-priority.low {
      background: #6c757d;
      color: white;
    }

    .ticket-subject {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .ticket-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }

    .ticket-category {
      color: #666;
      font-size: 0.9em;
    }

    .ticket-date {
      color: #888;
      font-size: 0.85em;
    }

    .ticket-message {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      color: #333;
      border-left: 4px solid #17408B;
      margin-bottom: 15px;
      font-style: italic;
    }

    .ticket-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ticket-actions select {
      width: auto;
      min-width: 120px;
      margin-bottom: 0;
      padding: 6px 12px;
      font-size: 0.9em;
    }

    .ticket-actions button {
      padding: 6px 16px;
      font-size: 0.9em;
    }

    /* Product List */
    #productList {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    #productList li {
      background-color: #fff;
      margin-bottom: 15px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    #productList li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #productList li strong {
      color: #17408B;
      font-size: 1.1em;
    }

    #productList li .price {
      color: #333;
      font-weight: 600;
    }

    #productList li button {
      background: #dc3545;
      padding: 8px 16px;
      font-size: 14px;
      margin-left: 15px;
    }

    #productList li button:hover {
      background: #c82333;
    }

    /* Form Section */
    #addProductForm {
      background-color: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #17408B;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      font-size: 1.2em;
      color: #17408B;
    }

    .loading::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #17408B;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-tickets {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    /* Separator */
    hr {
      border: none;
      height: 3px;
      background: linear-gradient(135deg, #17408B 0%, #C9082A 100%);
      margin: 40px 0;
      border-radius: 2px;
    }

    /* ===== DARK MODE STYLES FOR ADMIN ===== */
    body.dark-mode.with-nav {
      background-color: #121212 !important;
    }

    body.dark-mode .page-header {
      background: linear-gradient(135deg, #0d47a1 0%, #b71c1c 100%) !important;
    }

    body.dark-mode .admin-content {
      background-color: #1e1e1e !important;
      color: #f0f0f0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .admin-content h1, 
    body.dark-mode .admin-content h2, 
    body.dark-mode .admin-content h3 {
      color: #f0f0f0 !important;
    }

    body.dark-mode .admin-content h2 {
      color: #64b5f6 !important;
    }

    body.dark-mode .admin-content h3 {
      color: #f44336 !important;
    }

    /* Input Fields Dark Mode */
    body.dark-mode input[type="text"], 
    body.dark-mode input[type="number"],
    body.dark-mode select {
      background-color: #2a2a2a !important;
      color: #f0f0f0 !important;
      border-color: #555 !important;
    }

    body.dark-mode input[type="text"]:focus, 
    body.dark-mode input[type="number"]:focus,
    body.dark-mode select:focus {
      border-color: #64b5f6 !important;
      box-shadow: 0 0 0 3px rgba(100, 181, 246, 0.1) !important;
    }

    /* Tickets Dark Mode */
    body.dark-mode .tickets-controls {
      background-color: #2a2a2a !important;
    }

    body.dark-mode .ticket-item {
      background-color: #2a2a2a !important;
      border-color: #444 !important;
      color: #f0f0f0;
    }

    body.dark-mode .ticket-header {
      border-bottom-color: #444 !important;
    }

    body.dark-mode .ticket-id {
      color: #64b5f6 !important;
    }

    body.dark-mode .ticket-user {
      color: #cccccc !important;
    }

    body.dark-mode .ticket-subject {
      color: #f0f0f0 !important;
    }

    body.dark-mode .ticket-category {
      color: #cccccc !important;
    }

    body.dark-mode .ticket-date {
      color: #aaa !important;
    }

    body.dark-mode .ticket-message {
      background-color: #333 !important;
      color: #f0f0f0 !important;
      border-left-color: #64b5f6 !important;
    }

    /* Table Dark Mode */
    body.dark-mode table {
      background-color: #1e1e1e !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode th {
      background: linear-gradient(135deg, #0d47a1 0%, #b71c1c 100%) !important;
      color: #fff !important;
    }

    body.dark-mode td {
      background-color: #2a2a2a !important;
      color: #f0f0f0 !important;
      border-color: #444 !important;
    }

    body.dark-mode tbody tr:nth-child(even) td {
      background-color: #333 !important;
    }

    body.dark-mode tbody tr:hover td {
      background-color: #424242 !important;
    }

    /* Product List Dark Mode */
    body.dark-mode #productList {
      background-color: #2a2a2a !important;
    }

    body.dark-mode #productList li {
      background-color: #333 !important;
      color: #f0f0f0 !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode #productList li:hover {
      background-color: #424242 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    body.dark-mode #productList li strong {
      color: #64b5f6 !important;
    }

    body.dark-mode #productList li .price {
      color: #f0f0f0 !important;
    }

    /* Form Section Dark Mode */
    body.dark-mode #addProductForm {
      background-color: #2a2a2a !important;
      border-left-color: #64b5f6 !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-container {
        padding: 15px;
      }

      .admin-content {
        padding: 25px;
      }

      .page-header h1 {
        font-size: 2.5em;
      }

      .tickets-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .tickets-controls select {
        width: 100%;
      }

      .ticket-details {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .ticket-actions {
        flex-direction: column;
      }

      .ticket-actions select,
      .ticket-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body class="with-nav">
  <div class="form-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>🔧 Admin Control Panel</h1>
      <p>Manage users, products, support tickets, and monitor system activity</p>
    </div>

    <!-- Admin Content -->
    <div class="admin-content">
      <h2>📊 User Activity</h2>
      <input type="text" id="prefixInput" placeholder="Filter by username prefix..." />

      <table>
        <thead>
          <tr>
            <th>Datetime</th>
            <th>Username</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody id="activityTableBody"></tbody>
      </table>

      <hr>
      <h2>🎫 Support Tickets Management</h2>
      <div class="tickets-controls">
        <select id="statusFilter">
          <option value="">All Status</option>
          <option value="open">Open</option>
          <option value="in-progress">In Progress</option>
          <option value="resolved">Resolved</option>
        </select>
        <select id="priorityFilter">
          <option value="">All Priorities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <button onclick="loadTickets()">Refresh Tickets</button>
      </div>
      <div id="ticketsContainer">
        <div class="loading">Loading support tickets...</div>
      </div>

      <hr>
      <h2>🧰 Manage Products</h2>
      <form id="addProductForm">
        <input type="text" id="productName" placeholder="Product Name" required>
        <input type="text" id="productDescription" placeholder="Product Description" required>
        <input type="number" id="productPrice" placeholder="Product Price" required step="0.01" min="0">
        <input type="text" id="productImage" placeholder="Image URL (optional)">
        <button type="submit">Add Product</button>
      </form>

      <h3>📟 Current Products</h3>
      <ul id="productList" style="list-style: none; padding: 0;"></ul>
    </div>
  </div>

  <script src="navbar.js"></script>
  <script>
    const prefixInput = document.getElementById('prefixInput');
    const tableBody = document.getElementById('activityTableBody');

    async function loadActivity() {
      const prefix = prefixInput.value.trim();
      const res = await fetch('/admin-activity?prefix=' + encodeURIComponent(prefix));
      const data = await res.json();

      tableBody.innerHTML = '';
      data.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(entry.datetime).toLocaleString()}</td>
          <td>${entry.username}</td>
          <td>${entry.type}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    prefixInput.addEventListener('input', loadActivity);

    // Support Tickets Management
    async function loadTickets() {
      const container = document.getElementById('ticketsContainer');
      const statusFilter = document.getElementById('statusFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      
      try {
        container.innerHTML = '<div class="loading">Loading support tickets...</div>';
        
        let url = '/admin/tickets';
        const params = new URLSearchParams();
        if (statusFilter) params.append('status', statusFilter);
        if (priorityFilter) params.append('priority', priorityFilter);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url);
        
        if (response.status === 401) {
          container.innerHTML = '<div class="empty-tickets">Access denied. Admin login required.</div>';
          return;
        }

        if (response.status === 403) {
          container.innerHTML = '<div class="empty-tickets">Access denied. Admin privileges required.</div>';
          return;
        }

        if (response.ok) {
          const tickets = await response.json();
          
          if (!tickets || tickets.length === 0) {
            container.innerHTML = '<div class="empty-tickets">No support tickets found.</div>';
            return;
          }

          const ticketsHtml = tickets.map(ticket => `
            <div class="ticket-item" id="ticket-${ticket.id}">
              <div class="ticket-header">
                <div>
                  <span class="ticket-id">#${ticket.id}</span>
                  <span class="ticket-user">by ${ticket.username}</span>
                </div>
                <div>
                  <span class="ticket-status ${ticket.status}" id="status-badge-${ticket.id}">${ticket.status.replace('-', ' ')}</span>
                  <span class="ticket-priority ${ticket.priority}">${ticket.priority}</span>
                </div>
              </div>
              <div class="ticket-subject">${ticket.subject}</div>
              <div class="ticket-details">
                <div class="ticket-category">📂 Category: ${ticket.category.charAt(0).toUpperCase() + ticket.category.slice(1)}</div>
                <div class="ticket-date">📅 Created: ${new Date(ticket.created).toLocaleDateString()} at ${new Date(ticket.created).toLocaleTimeString()}</div>
              </div>
              ${ticket.updated && ticket.updated !== ticket.created ? 
                `<div style="font-size: 0.85em; color: #888; margin-bottom: 10px;">
                  🔄 Last updated: ${new Date(ticket.updated).toLocaleDateString()} at ${new Date(ticket.updated).toLocaleTimeString()}
                </div>` : ''
              }
              <div class="ticket-message">${ticket.message}</div>
              <div class="ticket-actions">
                <select id="status-${ticket.id}">
                  <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>Open</option>
                  <option value="in-progress" ${ticket.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                  <option value="resolved" ${ticket.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                </select>
                <button onclick="updateTicketStatus('${ticket.id}')" style="background: #28a745;">Update Status</button>
              </div>
            </div>
          `).join('');

          container.innerHTML = ticketsHtml;
        } else {
          throw new Error('Failed to load tickets');
        }

      } catch (error) {
        console.error('Error loading tickets:', error);
        container.innerHTML = '<div class="empty-tickets">Error loading support tickets. Please try again.</div>';
      }
    }

    async function updateTicketStatus(ticketId) {
      const statusSelect = document.getElementById(`status-${ticketId}`);
      const newStatus = statusSelect.value;
      const updateButton = statusSelect.nextElementSibling;
      
      // Store original button state
      const originalButtonText = updateButton.innerHTML;
      
      try {
        // Show loading state
        updateButton.disabled = true;
        updateButton.innerHTML = 'Updating...';
        updateButton.style.background = '#6c757d';
        
        const response = await fetch(`/admin/tickets/${ticketId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus }),
          credentials: 'include'
        });

        if (response.ok) {
          const result = await response.json();
          
          // Show success feedback
          updateButton.innerHTML = 'Updated!';
          updateButton.style.background = '#28a745';
          
          console.log(`Ticket ${ticketId} updated successfully:`, result);
          
          // Refresh the tickets list after a short delay
          setTimeout(() => {
            loadTickets();
          }, 1000);
          
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to update ticket status');
        }
      } catch (error) {
        console.error('Error updating ticket:', error);
        
        // Show error feedback
        updateButton.innerHTML = 'Error!';
        updateButton.style.background = '#dc3545';
        
        alert('Error updating ticket: ' + error.message);
        
        // Reset button after delay
        setTimeout(() => {
          updateButton.disabled = false;
          updateButton.innerHTML = originalButtonText;
          updateButton.style.background = '#28a745';
        }, 2000);
      }
    }

    // Add event listeners for filters
    document.getElementById('statusFilter').addEventListener('change', loadTickets);
    document.getElementById('priorityFilter').addEventListener('change', loadTickets);

    // Product management
    const addForm = document.getElementById('addProductForm');
    const productList = document.getElementById('productList');

    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('productName').value.trim();
      const description = document.getElementById('productDescription').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);
      const image = document.getElementById('productImage').value.trim();

      const res = await fetch('/admin-add-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, price, image })
      });

      if (res.ok) {
        alert('Product added!');
        addForm.reset();
        loadProducts();
      } else {
        alert('Error: ' + await res.text());
      }
    });

    async function loadProducts() {
      const res = await fetch('/admin-products');
      const products = await res.json();

      productList.innerHTML = '';
      products.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${p.name}</strong> - <span class="price">$${p.price.toFixed(2)}</span>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="removeProduct('${p.id}')" style="background: #dc3545;">
              🗑 Remove (POST)
            </button>
            <button onclick="removeProductWithDelete('${p.id}')" style="background: #e74c3c;">
              🗑 Delete (DELETE)
            </button>
          </div>
        `;
        productList.appendChild(li);
      });
    }

    async function removeProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      const res = await fetch('/admin-remove-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });

      if (res.ok) {
        alert('Product removed');
        loadProducts();
      } else {
        alert('Error: ' + await res.text());
      }
    }

    async function removeProductWithDelete(id) {
      if (!confirm('Are you sure you want to delete this product? (Using DELETE method)')) return;

      try {
        const res = await fetch(`/admin-products/${id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          const result = await res.json();
          alert(`Product "${result.deletedProduct.name}" deleted successfully using DELETE method!`);
          loadProducts();
        } else {
          const error = await res.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('Error deleting product');
      }
    }

    // Initialize page
    window.onload = () => {
      loadActivity();
      loadProducts();
      loadTickets();
    };
  </script>
</body>
</html>